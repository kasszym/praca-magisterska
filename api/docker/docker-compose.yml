version: '3.8'

services:
  api:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: aureon_api
    restart: unless-stopped
    environment:
      APP_ENV: production
      APP_DEBUG: 'false'
      APP_KEY: ${APP_KEY}
      DB_CONNECTION: ${DB_CONNECTION}
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # ensure Laravel points to the websockets service on the internal docker network
      PUSHER_HOST: websockets
      PUSHER_PORT: 6001
      PUSHER_SCHEME: http
      # other envs from your .env if needed
    volumes:
      - ..:/var/www/html:delegated
    depends_on: []

  web:
    image: nginx:stable-alpine
    container_name: aureon_api_web
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ..:/var/www/html:ro,delegated
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api

  websockets:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: aureon_websockets
    restart: unless-stopped
    env_file:
      - ../api/.env
    environment:
      # make sure the websockets process advertises the same host when invoked internally
      PUSHER_HOST: websockets
      PUSHER_PORT: 6001
      PUSHER_SCHEME: http
    volumes:
      - ..:/var/www/html:delegated
    command: php artisan websockets:run --host=0.0.0.0 --port=6001
    ports:
      - "6001:6001"
    depends_on:
      - api

# Note: DB is external. Ensure the DB_* environment variables are set in .env or exported before running compose.
